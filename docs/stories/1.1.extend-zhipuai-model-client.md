# Story 1.1: 扩展智谱AI模型客户端实现

## Status
Draft

## Story

**As a** 系统开发者,
**I want** 完善后端ZhipuAIModelClient实现，确保完整支持智谱AI的OpenAI兼容API,
**so that** 系统可以通过OpenAI Python SDK无缝调用智谱AI模型，为用户提供额外的AI模型选择

## Acceptance Criteria

1. 实现完整的ZhipuAIModelClient类，继承自BaseModelClient
2. 支持智谱AI的所有主要模型（glm-4.6, glm-4.5-air, glm-4.5v, glm-4.5-flash等）
3. 提供OpenAI SDK兼容的接口，支持同步和异步调用
4. 实现模型特定的参数优化和错误处理
5. 支持流式响应和推理模式
6. 包含完整的配置验证和默认配置
7. 提供详细的API调用日志和错误处理

## Tasks / Subtasks

- [ ] Task 1: 创建ZhipuAIModelClient基础类结构 (AC: 1)
  - [ ] 创建`src/magentic_ui/backend/model_clients/zhipuai_client.py`文件
  - [ ] 实现ZhipuAIModelClient类，继承自BaseModelClient
  - [ ] 实现基础的初始化方法和配置管理
  - [ ] 添加必需的导入和类型注解

- [ ] Task 2: 实现OpenAI兼容的客户端连接 (AC: 1, 3)
  - [ ] 实现`_create_zhipuai_client()`方法，使用OpenAI SDK
  - [ ] 配置智谱AI特定的base_url和认证
  - [ ] 实现API密钥管理和环境变量支持
  - [ ] 添加连接超时和重试配置

- [ ] Task 3: 实现模型调用核心功能 (AC: 2, 3)
  - [ ] 实现`generate_response()`异步方法
  - [ ] 实现模型名称映射和参数转换
  - [ ] 支持所有主要智谱AI模型
  - [ ] 添加请求参数验证和优化

- [ ] Task 4: 实现高级功能支持 (AC: 4, 5)
  - [ ] 实现`generate_streaming_response()`流式响应
  - [ ] 实现`generate_thinking_response()`推理模式
  - [ ] 添加模型特定的参数优化逻辑
  - [ ] 实现智能的模型选择建议

- [ ] Task 5: 实现配置管理和验证 (AC: 6)
  - [ ] 实现`get_default_config()`方法
  - [ ] 实现`validate_config()`方法
  - [ ] 添加配置字段验证和错误提示
  - [ ] 提供智谱AI特定的配置模板

- [ ] Task 6: 实现错误处理和日志记录 (AC: 7)
  - [ ] 添加智谱AI特定的异常类
  - [ ] 实现详细的错误日志记录
  - [ ] 添加API调用监控和指标收集
  - [ ] 实现优雅的降级和重试机制

- [ ] Task 7: 创建单元测试 (AC: 全部)
  - [ ] 创建`tests/unit/test_backend/test_zhipuai_client.py`
  - [ ] 测试所有主要方法的正常流程
  - [ ] 测试错误处理和异常情况
  - [ ] 测试配置验证和模型映射

- [ ] Task 8: 集成到ModelClientFactory (AC: 全部)
  - [ ] 更新ModelClientFactory以支持ZhipuAI提供商
  - [ ] 添加提供商注册逻辑
  - [ ] 测试工厂模式的完整集成
  - [ ] 验证与现有系统的兼容性

## Dev Notes

### 数据模型信息
**基于架构文档分析：**
- `ModelClientConfigs` 类位于 `src/magentic_ui/magentic_ui_config.py:22-61` [Source: architecture/data-models.md#ModelClientConfigs]
- 当前支持的模型客户端配置包括：orchestrator, web_surfer, coder, file_surfer, action_guard [Source: src/magentic_ui/magentic_ui_config.py:33-37]
- 默认配置使用OpenAI模型 "gpt-4.1-2025-04-14" [Source: src/magentic_ui/magentic_ui_config.py:42]

### API规范和架构
**后端架构信息：**
- 团队管理器位于 `src/magentic_ui/backend/teammanager/teammanager.py` [Source: architecture/backend-architecture.md#Service Architecture]
- 使用FastAPI框架和异步模式 [Source: architecture/backend-architecture.md#Controller Template]
- 模型客户端需要支持异步调用模式 [Source: architecture/tech-stack.md#Backend Framework]

### 智谱AI技术规范
**从智谱AI架构文档提取：**
- 智谱AI OpenAI兼容端点：`https://open.bigmodel.cn/api/paas/v4/` [Source: architecture/智谱AI集成架构深度分析.md#ZhipuAIModelClient实现]
- 支持的主要模型：
  - `glm-4.6`: 最强性能模型，支持复杂推理任务
  - `glm-4.5-air`: 平衡性能和成本
  - `glm-4.5v`: 视觉理解模型
  - `glm-4-air`: 轻量级模型 [Source: architecture/智谱AI集成架构深度分析.md#智谱AI模型配置管理]

### 项目结构信息
**文件位置要求：**
- 新的模型客户端应放在 `src/magentic_ui/backend/model_clients/` 目录下 [Source: architecture/unified-project-structure.md]
- 测试文件应放在 `tests/unit/test_backend/` 目录下 [Source: architecture/testing-strategy.md#Backend Tests]
- 需要遵循Python snake_case命名约定 [Source: architecture/coding-standards.md#Naming Conventions]

### 技术栈和依赖
**从技术栈文档：**
- Python 3.12+ 作为后端开发语言 [Source: architecture/tech-stack.md#Backend Language]
- 使用OpenAI Python SDK 1.0+ 进行智谱AI调用 [Source: architecture/tech-stack.md#AI Model Client]
- 支持异步操作和错误处理 [Source: architecture/coding-standards.md#Critical Fullstack Rules]

### 编码标准
**必须遵循的编码标准：**
- 所有I/O操作必须使用async/await模式 [Source: architecture/coding-standards.md#Critical Fullstack Rules]
- 每个API端点必须有适当的错误处理 [Source: architecture/coding-standards.md#Critical Fullstack Rules]
- 使用类型提示和Pydantic进行数据验证 [Source: architecture/coding-standards.md#Critical Fullstack Rules]
- 绝不在代码中硬编码敏感信息 [Source: architecture/coding-standards.md#Critical Fullstack Rules]

### Previous Story Insights
无前一个故事，这是Epic的第一个故事。

### Testing
**测试标准要求：**
- 单元测试：使用pytest + pytest-asyncio [Source: architecture/testing-strategy.md#Backend Testing]
- 测试文件位置：`tests/unit/test_backend/test_zhipuai_client.py` [Source: architecture/testing-strategy.md#Backend Tests]
- 必须包含：
  - 所有主要方法的正常流程测试
  - 错误处理和异常情况测试
  - 配置验证测试
  - 异步调用测试 [Source: architecture/testing-strategy.md#Backend API Test]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-21 | 1.0 | Initial story creation | ssiagu |

## Dev Agent Record

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

## QA Results
*To be populated by QA agent*